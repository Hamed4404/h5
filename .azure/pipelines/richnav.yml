#
# See https://docs.microsoft.com/en-us/vsts/pipelines/yaml-schema for details on this file.
#

# Configure which branches trigger builds
trigger:
  branches:
    include:
    - blazor-wasm
    - master
    - release/*
    - internal/release/*

variables:
- name: _BuildArgs
  value: '/p:SkipTestBuild=true'
- name: Windows64LogArgs
  value: /bl:artifacts/log/Release/Build.x64.binlog
- name: Windows86LogArgs
  value: -ExcludeCIBinaryLog
- name: WindowsInstallersLogArgs
  value: /bl:artifacts/log/Release/Build.Installers.binlog

stages:
- stage: build
  displayName: Build
  jobs:
  # Build Windows (x64/x86)
  - template: jobs/default-build.yml
    parameters:
      codeSign: false
      jobName: Windows_build
      jobDisplayName: "Build: Windows x64/x86"
      enableRichCodeNavigation: true
      agentOs: Windows
      steps:
      - script: ./build.cmd
                -ci
                -build
                -restore
                -arch x64
                $(_BuildArgs)
                $(Windows64LogArgs)
        displayName: Build x64

      # Build the x86 shared framework
      # This is going to actually build x86 native assets.
      - script: ./build.cmd
                -ci
                -noBuildRepoTasks
                -arch x86
                -build
                -restore
                -noBuildJava
                -noBuildNative
                $(_BuildArgs)
                $(Windows86LogArgs)
        displayName: Build x86

      - script: .\src\SiteExtensions\build.cmd
                -ci
                -noBuildRepoTasks
                -build
                -restore
                -noBuildDeps
                -noBuildNative
                $(_BuildArgs)
        condition: ne(variables['Build.Reason'], 'PullRequest')
        displayName: Build SiteExtension

      # Windows installers bundle both x86 and x64 assets
      - script: ./build.cmd
                -ci
                -noBuildRepoTasks
                -buildInstallers
                -noBuildNative
                /p:AssetManifestFileName=aspnetcore-win-x64-x86.xml
                $(_BuildArgs)
                $(WindowsInstallersLogArgs)
        displayName: Build Installers

