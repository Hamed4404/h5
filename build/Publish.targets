<Project>

  <!-- Inserts the Razor VSIX to the VS drop share -->
  <Target Name="RunVSDrop" DependsOnTargets="GetToolsets">
    <Error Text="MSBuild could not be located."
      Condition="'$(VisualStudioMSBuildx86Path)'==''" />

    <ItemGroup>
      <SignedRazorVSIX Include="$(SignedVSIXPath)*.vsix" />

      <MSBuildExeArgs Include="
        $(MSBuildThisFileDirectory)vsdrop\drop.msbuild;
        /t:BuildAndPublishManifest;
        /p:SignedVsixPath=$(SignedVSIXPath);
        /p:RepositoryRoot=$(RepositoryRoot);
        /p:ManifestRepositoryName=AspNetCore/%(SignedRazorVSIX.FileName);
        /p:ManifestBuildBranch=$(BUILD_BRANCH);
        /p:ManifestBuildNumber=$(BUILD_NUMBER)" />
    </ItemGroup>

    <Run FileName="$(VisualStudioMSBuildx86Path)" Arguments="@(MSBuildExeArgs)" Condition="Exists($(RazorVSIXFullPath))" />
  </Target>

  <Target Name="GetFilesToPublish">
    <ItemGroup>
      <PackagesToPublish Include="$(CoherenceSignedDestinationDir)Packages\*.nupkg" />
      <PackagesToPublish Include="$(CoherenceSignedDestinationDir)OobPackages\*.nupkg" />
      <PackagesToPublish Include="$(CoherenceDestinationDir)ext\*.nupkg" />
      <PackagesToPublish Include="$(CoherenceDestinationDir)noship\*.nupkg" />

      <FilesToPublish Include="$(CoherenceSignedDestinationDir)store\*.zip" />
      <FilesToPublish Update="@(FilesToPublish)" RelativeBlobPath="$(FileRelativePathBase)/%(FileName)%(Extension)" />
    </ItemGroup>
  </Target>

  <Target Name="PushPackages" DependsOnTargets="GetArtifactInfo">
    <Error Message="No packages found to publish" Condition="@(PackagesToPublish->Count()) == 0" />

    <PushNuGetPackages
      Packages="@(PackagesToPublish)"
      Feed="$(PublishFeed)"
      ApiKey="$(APIKey)" />
  </Target>

</Project>
