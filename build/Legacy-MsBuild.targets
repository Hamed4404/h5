<Project DefaultTargets="Build">
  <Import Project="Legacy-MsBuild.props" />
  <Import Project="QERM.targets" />
  <Import Project="Sign.targets" />
  <Import Project="Policheck.targets" />

  <PropertyGroup>
    <PublishFeed>https://dotnet.myget.org/F/aspnetcore-dev/</PublishFeed>
    <NuGetV3Feed>https://api.nuget.org/v3/index.json</NuGetV3Feed>
    <BuildToolsFeed>https://dotnet.myget.org/F/aspnetcore-tools/api/v2</BuildToolsFeed>
    <CoherenceDestinationDir>$(ArtifactsPath)coherence\</CoherenceDestinationDir>
    <CoherencePackageCacheDestinationDir>$(ArtifactsPath)coherence-packageCache\</CoherencePackageCacheDestinationDir>
    <CoherenceSignedDestinationDir>$(ArtifactsPath)Signed\</CoherenceSignedDestinationDir>
    <CodeSignApprovers>elipton;joeloff</CodeSignApprovers>
  </PropertyGroup>

  <Target Name="Build" DependsOnTargets="Sign;RunVSDrop;BinScope;" />

  <Target Name="RunVSDrop">
    <ItemGroup>
      <SignedRazorVSIX Include="$(SignedVSIXPath)*.vsix" />
    </ItemGroup>

    <MSBuild
        Projects="$(MSBuildProjectDirectory)\vsdrop\drop.msbuild"
        Targets="BuildAndPublishManifest"
        Properties="
                SignedVsixPath=$([System.IO.Path]::GetDirectoryName(%(SignedRazorVSIX.FullPath)));
                RepositoryRoot=$(RepositoryRoot)\;
                ManifestRepositoryName=AspNetCore/%(SignedRazorVSIX.FileName);
                ManifestBuildBranch=$(BUILD_BRANCH);
                ManifestBuildNumber=$(BUILD_NUMBER)" />
  </Target>
</Project>
