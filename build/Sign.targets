<Project>
  <PropertyGroup>
    <SignDependsOn>
      PrepareFilesForSigning;
      SignFiles;
      RebuildOobArchives;
      RebuildPackages;
      SignNupkgs;
      RebuildSharedFxs;
      RepackMPacks;
      SignCheck;
    </SignDependsOn>
  </PropertyGroup>

  <Target Name="Sign" DependsOnTargets="$(SignDependsOn)" />

  <Target Name="PrepareFilesForSigning">
    <ItemGroup>
      <!--
        apphost.exe is intentionally excluded because customers are expected to codesign this file themselves
        after the SDK tweaks the binary with the entrypoint name.
       -->
      <SignExclusions Include="$(UnsignedPackagesPath)**\AppHostTemplate\apphost.exe" />

      <ThirdPartyBinaries Include="
        $(UnsignedPackagesPath)**\MsgPack.dll;
        $(UnsignedPackagesPath)**\MessagePack.dll;
        $(UnsignedPackagesPath)**\newtonsoft*.dll;
        $(UnsignedPackagesPath)**\remotion*.dll;
        $(UnsignedPackagesPath)**\sqlitepclraw*.dll;
        $(UnsignedPackagesPath)**\e_sqlite3.dll;
        $(UnsignedPackagesPath)**\stackexchange*.dll;
        $(UnsignedPackagesPath)**\System.Interactive.Async.dll"
        Exclude="@(SignExclusions)" />

      <PackageBinaries Include="
        $(UnsignedPackagesPath)**\*.dll;
        $(UnsignedPackagesPath)**\*.exe;
        $(UnsignedPackagesPath)**\*.psd1;
        $(UnsignedPackagesPath)**\*.psm1;
        $(UnsignedPackagesPath)**\*.ps1;"
        Exclude="@(ThirdPartyBinaries);@(SignExclusions)" />

      <OobArchiveBinaries Include="$(UnsignedOobArchivePath)**\*.dll"
        Exclude="@(SignExclusions)" />

      <ThirdPartyBinaries Include="
        $(UnsignedSharedFxPath)**\MsgPack.dll;
        $(UnsignedSharedFxPath)**\MessagePack.dll;
        $(UnsignedSharedFxPath)**\newtonsoft*.dll;
        $(UnsignedSharedFxPath)**\remotion*.dll;
        $(UnsignedSharedFxPath)**\sqlitepclraw*.dll;
        $(UnsignedSharedFxPath)**\e_sqlite3.dll;
        $(UnsignedSharedFxPath)**\stackexchange*.dll;
        $(UnsignedSharedFxPath)**\System.Interactive.Async.dll"
        Exclude="@(SignExclusions)" />

      <SharedFxBinaries Include="
        $(UnsignedSharedFxPath)**\microsoft.*.dll;
        $(UnsignedSharedFxPath)**\system.*.dll;
        $(UnsignedSharedFxPath)**\libuv.dll;
        $(UnsignedSharedFxPath)**\aspnetcorev2_inprocess.dll;
        $(UnsignedSharedFxPath)**\Microsoft.NETCore.App\*\*.dll;
        $(UnsignedSharedFxPath)**\host\fxr\*\*.dll;
        $(UnsignedSharedFxPath)**\dotnet.exe;
        $(UnsignedSharedFxPath)**\sni.dll"
        Exclude="@(ThirdPartyBinaries);@(SignExclusions)"/>

      <UnaccountedSharedFxBinaries Include="$(UnsignedSharedFxPath)**\*.dll" Exclude="@(SharedFxBinaries);@(ThirdPartyBinaries)"/>

      <MPackBinaries Include="$(UnsignedMPacksPath)**\*.dll"
        Exclude="@(SignExclusions)" />
    </ItemGroup>


    <Error Text="Additional binaries found in the aspnetcore shared framework which are not marked for signing:%0A -  @(UnaccountedSharedFxBinaries, '%0A - ')" Condition="'@(UnaccountedSharedFxBinaries)'!=''"/>
  </Target>

  <Target Name="SignFiles">
    <ItemGroup>
      <MicrosoftBinaries Include="
        @(PackageBinaries);
        @(OobArchiveBinaries);
        @(MPackBinaries);
        @(SharedFxBinaries);" />
    </ItemGroup>

    <ItemGroup>
      <_SignProject Remove="@(_SignProject)" />
      <_SignProject Include="$(MSBuildProjectFullPath)" Condition ="'@(MicrosoftBinaries)' != ''">
        <AdditionalProperties>
          LocalBuild=$(LocalBuild);
          Certificate=$(MicrosoftAuthentiCodeSha2);
          JobName=MicrosoftBinaries;
          Files=@(MicrosoftBinaries)
        </AdditionalProperties>
      </_SignProject>

      <_SignProject Include="$(MSBuildProjectFullPath)" Condition="'@(ThirdPartyBinaries)'!=''" >
        <AdditionalProperties>
          LocalBuild=$(LocalBuild);
          Certificate=$(Microsoft3rdPartyAppComponentDual);
          JobName=ThirdPartyBinaries;
          Files=@(ThirdPartyBinaries)
        </AdditionalProperties>
      </_SignProject>
    </ItemGroup>

    <MSBuild Projects="@(_SignProject)" Targets="SubmitCodeSign" BuildInParallel="true" Condition="'@(_SignProject)' != '' AND '$(SignType)'=='real' " />
  </Target>

  <Target Name="RebuildPackages">
    <MakeDir Directories="$(PackageOutputPath)" />

    <ItemGroup>
      <NuSpec Include="$(UnsignedPackagesPath)**\*.nuspec" />
    </ItemGroup>

    <MSBuild
      Projects="$(MSBuildProjectFullPath)"
      Targets="ZipFile"
      Properties="ZipRoot=%(NuSpec.RootDir)%(NuSpec.Directory);OutputDir=$(UnsignedPackagesWithSignedBinariesPath);Extension=.nupkg"
      Condition="'@(NuSpec)'!=''" />
  </Target>

  <Target Name="SignNupkgs">
    <ItemGroup>
      <_UnsignedNupkgs Include="$(UnsignedPackagesWithSignedBinariesPath)**\*.nupkg" />
    </ItemGroup>

    <Microsoft.Build.OOB.ESRP.CreateSignManifests Condition="'@(_UnsignedNupkgs)'!=''"
       ApplicationId="$(ESRPApplicationId)"
       DestinationRootDirectory="$(PackagesOutputPath)"
       Files="@(_UnsignedNupkgs)"
       ManifestOutputPath="$(LogOutputDir)nupkg\"
       KeyCodes="$(MicrosoftNuGet)">
      <Output TaskParameter="AuthJson" PropertyName="AuthJson_Nupkg" />
      <Output TaskParameter="PolicyJson" PropertyName="PolicyJson_Nupkg" />
      <Output TaskParameter="InputJson" PropertyName="InputJson_Nupkg" />
      <Output TaskParameter="OutputJson" PropertyName="OutputJson_Nupkg" />
    </Microsoft.Build.OOB.ESRP.CreateSignManifests>

    <Exec
      Command="$(ESRPClientToolPath) sign -c $(ESRPClientConfigFile) -a $(AuthJson_Nupkg) -p $(PolicyJson_Nupkg) -i $(InputJson_Nupkg) -o $(OutputJson_Nupkg) -l progress -f $(LogOutputDir)sign-nupkg.log"
      Condition="'$(SignType)'=='real' AND '$(LocalBuild)'!='true'" />

    <StupidCopy Condition="'$(SignType)'!='real' OR '$(LocalBuild)'=='true'"
      SourceFiles="@(_UnsignedNupkgs)"
      DestinationFolder="$(PackagesOutputPath)" />
  </Target>

  <!-- Repacks MPacks with their signed binaries -->
  <Target Name="RepackMPacks">
    <MakeDir Directories="$(SignedMPacksOutputPath)" />

    <ItemGroup>
      <MPackDirectories Include="$([System.IO.Directory]::GetDirectories(&quot;$(UnsignedMPacksPath)&quot;))" Condition="Exists($(UnsignedMPacksPath))" />
    </ItemGroup>

    <MSBuild Condition=" '@(MPackDirectories)' != '' "
      Projects="$(MSBuildProjectFullPath)"
      Properties="MPackDirectory=%(MPackDirectories.Identity);"
      Targets="_RepackMPack"/>
  </Target>

  <Target Name="_RepackMPack">
    <PropertyGroup>
      <MPackName>$([System.IO.Path]::GetFileName($(MPackDirectory)))</MPackName>
      <OutputFile>$(SignedMPacksOutputPath)$(MPackName).mpack</OutputFile>
    </PropertyGroup>

    <ItemGroup>
      <Files Include="$(MPackDirectory)\*" />
    </ItemGroup>

    <ZipArchive Condition="'@(Files)' != ''"
      File="$(OutputFile)"
      SourceFiles="@(Files)"
      WorkingDirectory="$(MPackDirectory)" />
  </Target>

  <Target Name="SubmitCodeSign">
    <Message Text="Executing code sign job $(JobName)" Importance="High" />

    <PropertyGroup>
      <SigningStagingDir>$(IntermediateDir)u\$(JobName)\</SigningStagingDir>
      <SignOutputDir>$(IntermediateDir)s\$(JobName)\</SignOutputDir>
    </PropertyGroup>

    <ItemGroup>
      <_FilesPath Include="$(Files)" />
    </ItemGroup>

    <RepoTasks.GetFileHash Files="@(_FilesPath)">
      <Output TaskParameter="Items" ItemName="_FilesWithHash"/>
    </RepoTasks.GetFileHash>

    <RepoTasks.FilterAuthenticodeSignedFiles Files="@(_FilesWithHash)">
      <Output TaskParameter="Unsigned" ItemName="_UnsignedFilesWithHash"/>
    </RepoTasks.FilterAuthenticodeSignedFiles>

    <ItemGroup>
      <_FilesToSign Include="$(SigningStagingDir)%(_UnsignedFilesWithHash.FileHash)%(_UnsignedFilesWithHash.Extension)" Condition=" '%(_UnsignedFilesWithHash.Identity)' != '' ">
        <OriginalFilePath>%(_UnsignedFilesWithHash.Identity)</OriginalFilePath>
      </_FilesToSign>
    </ItemGroup>

    <Message Text="$(JobName): Submitting @(_FilesToSign->Distinct()->Count()) unique files for signing" Importance="High" />

    <StupidCopy SourceFiles="@(_FilesToSign->Distinct()->'%(OriginalFilePath)')" DestinationFiles="%(_FilesToSign.Identity)" />

    <Microsoft.Build.OOB.ESRP.CreateSignManifests Condition="@(_FilesToSign->Count()) != 0"
       ApplicationId="$(ESRPApplicationId)"
       DestinationRootDirectory="$(SignOutputDir)"
       Files="@(_FilesToSign->Distinct())"
       ManifestOutputPath="$(LogOutputDir)sign\$(JobName)\"
       KeyCodes="$(Certificate)">
      <Output TaskParameter="AuthJson" PropertyName="AuthJson" />
      <Output TaskParameter="PolicyJson" PropertyName="PolicyJson" />
      <Output TaskParameter="InputJson" PropertyName="InputJson" />
      <Output TaskParameter="OutputJson" PropertyName="OutputJson" />
    </Microsoft.Build.OOB.ESRP.CreateSignManifests>

    <Exec
      Command="$(ESRPClientToolPath) sign -c $(ESRPClientConfigFile) -a $(AuthJson) -p $(PolicyJson) -i $(InputJson) -o $(OutputJson) -l progress -f $(LogOutputDir)sign-$(JobName).log"
      Condition="'$(SignType)'=='real' AND '$(LocalBuild)'!='true' AND @(_FilesToSign->Count()) != 0 " />

    <Message Text="Finished code sign job $(JobName)" Importance="High" />

    <StupidCopy SourceFiles="@(_FilesToSign)" DestinationFolder="$(SignOutputDir)" Condition="'$(LocalBuild)'=='true'" />

    <StupidCopy SourceFiles="$(SignOutputDir)%(_FilesToSign.FileName)%(Extension)" DestinationFiles="%(OriginalFilePath)" Condition=" '%(_FilesToSign.Identity)' != '' " />
  </Target>

  <!-- Repacks aspnetcore shared framework -->
  <Target Name="RebuildSharedFxs">
    <MakeDir Directories="$(SharedFxOutputPath)" />

    <ItemGroup>
      <SharedFxFiles Include="$([System.IO.Directory]::GetDirectories(&quot;$(UnsignedSharedFxPath)&quot;))" Condition="Exists($(UnsignedSharedFxPath))" />
    </ItemGroup>

    <MSBuild Condition="'@(SharedFxFiles)' != ''"
      Projects="$(MSBuildProjectFullPath)"
      Properties="SharedFxFile=%(SharedFxFiles.Identity);OutDir=$(SharedFxOutputPath)"
      Targets="RebuildSharedFx"/>
  </Target>

  <Target Name="RebuildSharedFx">
    <PropertyGroup>
      <WorkingDir>$(SharedFxFile)</WorkingDir>
      <SharedFxName>$([System.IO.Path]::GetFileName($(SharedFxFile)))</SharedFxName>
      <OutputFile>$(OutDir)$(SharedFxName).zip</OutputFile>
    </PropertyGroup>
    <Error Condition="'$(OutDir)'==''" Text="Output dir not specified" />

    <Delete Files="$(OutputFile)" Condition="Exists('$(OutputFile)')" />

    <!-- see https://sevenzip.osdn.jp/chm/cmdline/ -->
    <Exec Command="&quot;$(ZipExePath)&quot; a -tzip -mx9 -r -y &quot;$(OutputFile)&quot; * > nul"
      WorkingDirectory="$(WorkingDir)" />
  </Target>

  <Target Name="RebuildOobArchives">
    <MakeDir Directories="$(SignedOobArchivePath)" />

    <ItemGroup>
      <OobArchiveFiles Include="$([System.IO.Directory]::GetDirectories(&quot;$(UnsignedOobArchivePath)&quot;))" Condition="Exists('$(UnsignedOobArchivePath)')" />
    </ItemGroup>

    <MSBuild Condition="'@(OobArchiveFiles)' != ''"
        Projects="$(MSBuildProjectFullPath)"
        Targets="ZipFile"
        Properties="ZipRoot=$([MSBuild]::NormalizeDirectory(%(OobArchiveFiles.FullPath)));OutputDir=$(SignedOobArchivePath);Extension=.zip" />
  </Target>

  <Target Name="ZipFile">
    <PropertyGroup>
      <FileName>$([System.IO.Path]::GetFileName($(ZipRoot.Trim('\'))))</FileName>
      <OutputFile>$(OutputDir)$(FileName)$(Extension)</OutputFile>
    </PropertyGroup>

    <ItemGroup>
      <Files Include="$(ZipRoot)**\*" />
    </ItemGroup>

    <ZipArchive
      File="$(OutputFile)"
      SourceFiles="@(Files)"
      WorkingDirectory="$(ZipRoot)"
      Overwrite="true" />
  </Target>

  <Target Name="SignCheck" >
    <Message Text="Running signcheck on output" Importance="high" />
    <Warning Condition="'$(SignType)' != 'real'"
      Text="Skipping sign check because SignType != real" />
    <Exec Condition="'$(SignType)' == 'real'"
      Command="$(SignCheckToolPath) --verify-jar -x $(SignCheckExclusionFile) --error-log-file $(LogOutputDir)signcheck.error.log --recursive --generate-exclusions-file $(LogOutputDir)signcheck.exclusions.g.txt -v Detailed -i $(SignedOutputPath)"
      StandardOutputImportance="Normal" />
  </Target>

</Project>
