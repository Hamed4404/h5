<Project>
  
  <PropertyGroup>
    <_BlazorCopyFilesToOutputDirectoryDependsOn>
      $(_BlazorCopyFilesToOutputDirectoryDependsOn);
      _PrepareBlazorAssetsManifestInputs;
      _PrepareBlazorAssetsManifestOutputs;
    </_BlazorCopyFilesToOutputDirectoryDependsOn>
  </PropertyGroup>

  <Target Name="_PrepareBlazorAssetsManifestInputs"
          Condition="'$(BlazorAssetsManifestPath)' != ''"
          DependsOnTargets="PrepareBlazorOutputs">

    <PropertyGroup>
      <_BlazorAssetsManifestIntermediateOutputPath>$(BlazorIntermediateOutputPath)assetsmanifest.json</_BlazorAssetsManifestIntermediateOutputPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Include _framework/* content -->
      <_BlazorAssetsManifestItem Include="@(BlazorOutputWithTargetPath)">
        <AssetUrl>$([System.String]::Copy('%(TargetOutputPath)').Replace('\','/').Substring(5))</AssetUrl>
      </_BlazorAssetsManifestItem>

      <!-- Include content from wwwroot -->
      <_BlazorAssetsManifestItem Include="@(ContentWithTargetPath)" Condition="$([System.String]::Copy('%(ContentWithTargetPath.TargetPath)').Replace('\','/').StartsWith('wwwroot/'))">
        <AssetUrl>$([System.String]::Copy('%(ContentWithTargetPath.TargetPath)').Replace('\','/').Substring(8))</AssetUrl>
      </_BlazorAssetsManifestItem>

      <!-- Include SWA from references -->
      <_BlazorAssetsManifestItem Include="@(StaticWebAsset)" Condition="'%(StaticWebAsset.SourceType)' != ''">
        <AssetUrl>%(StaticWebAsset.BasePath)/%(StaticWebAsset.RelativePath)</AssetUrl>
      </_BlazorAssetsManifestItem>
    </ItemGroup>

  </Target>

  <Target Name="_PrepareBlazorAssetsManifestOutputs"
          Inputs="@(_BlazorAssetsManifestItem)"
          Outputs="$(_BlazorAssetsManifestIntermediateOutputPath)">

    <GetFileHash Files="@(_BlazorAssetsManifestItem)" Algorithm="SHA256" HashEncoding="base64">
      <Output TaskParameter="Items" ItemName="_BlazorAssetWithHash" />  
    </GetFileHash>

    <WriteLinesToFile
      File="$(_BlazorAssetsManifestIntermediateOutputPath)"
      Lines="@(_BlazorAssetWithHash->'%(FileHash) %(AssetUrl)')"
      Overwrite="true" />

    <ItemGroup>
      <BlazorOutputWithTargetPath Include="$(_BlazorAssetsManifestIntermediateOutputPath)" TargetOutputPath="$(BaseBlazorDistPath)$(BlazorAssetsManifestPath)" />
      <FileWrites Include="$(_BlazorAssetsManifestIntermediateOutputPath)" />
    </ItemGroup>

  </Target>
</Project>
